{% extends 'main/base.html' %}
{% load crispy_forms_tags %}

{% block title %} Proyecto {% endblock %}
{% block css %} 
<link rel="stylesheet" href="{{STATIC_URL}}main/leaflet/leaflet.css"> 
{% endblock %}

{% block ngApp %} ng-app="alianzaTemplosApp"{% endblock %}
{% block controller %} ng-controller="ProyectoCtrl"{% endblock %}



{% block content %}

<ol class="breadcrumb" style="margin-top:20px;">
  <li><a href="/">Inicio</a></li> 
  <li class="active">{{proyecto.nombre_proyecto}}</li>
</ol>

<div class="page-header">
	<h1>{{proyecto.nombre_proyecto}} 
		<small>
			<a class="btn btn-success" href="{% url "proyecto_edit" pk=proyecto.pk %}">
				{% if user.tipo == user.LOCAL %}
					Editar
				{% elif user.tipo == user.REGIONAL or user.tipo == user.NACIONAL %}
					Revisar
				{% else %}
					Ver en detalle
				{% endif%}
			</a>
			<a href="" class="btn btn-info" ng-click="scrollTo('comentarios')" role="button">Comentar</a>
  	
  		</small> 
  		<span class="label label-primary pull-right">{{proyecto.pk}}</span></h1>
</div>

<div class="row">

	<div class="col-sm-8">

		<tabset>
			<tab heading="Edificacion">
							
					
				<div class="panel panel-default" style="margin-top:10px;">
					<leaflet defaults="defaults" markers="markers" center="proyectCenter"  height="200px"></leaflet>
				</div>
				
				
				<div class="row">
					<div class="col-sm-12">
						<table class="table table-bordered table-striped">
							<tbody>	
								<tr> <th>Dirección: </th>       <td>{{ proyecto.direccion}}</td> </tr>													
								<tr> <th>Coordenadas: </th> 	<td>{{ proyecto.coordenadas }}</td> </tr>
								<tr> <th>Dueño del Lote: </th> 	<td>{{ proyecto.get_owner_lote_display }}</td> </tr>
								<tr> <th>Adquisición: </th> 	<td>{{ proyecto.get_tipo_adquisicion_display }}</td> </tr>
								<tr> <th>Terreno: </th> 	    <td>{{ proyecto.dimensiones_terreno }}</td> </tr>
								<tr> <th>Edificio: </th> 	    <td>{{ proyecto.dimensiones_edificio }}</td> </tr>
								<tr> <th>No. pisos: </th> 	    <td>{{ proyecto.num_pisos }}</td> </tr>
								<tr> <th>Tipo: </th> 	        <td>{{ proyecto.get_tipo_construccion_display }}</td> </tr>
								<tr> <th>Metodo: </th> 	        <td>{{ proyecto.get_metodo_construccion_display }}</td> </tr>
								<tr> <th>Requiere permiso: </th>  <td>{{ proyecto.requiere_permiso|yesno:"Si,No,No sabemos" }}</td> </tr>
								<tr> <th>Tiempo límite: </th>     <td>{{ proyecto.tiempo_limite }} meses</td> </tr>			
							</tbody>
							
						</table>
					</div>
				</div>

			</tab>
			
			<tab heading="Finanzas">Static content</tab>
			<tab heading="Comunidad">Static content</tab>
			<tab heading="Congregación">Static content</tab>
			<tab heading="Adjuntos">Static content</tab>
			<tab heading="Condiciones">Static content</tab>
			
		</tabset>

		<br>

		<div id="comentarios" class="page-header">
			<h2>Comentarios ({{comentarios|length}})</h2>
		</div>

		<div class="clearfix">
			{% crispy comentarioForm %}
		</div>

		{% for coment in comentarios %}
		<ul class="media-list">
			{% if not coment.comentario_padre %}
				<li class="media clearfix">
					<i class="fa fa-comment-o fa-3x pull-left"></i>
					<div class="media-body">
						<h5 class="text-primary media-heading">{{coment.commenter}}  <small>hace {{coment.created|timesince}}</small> </h5>
						<p style="margin-bottom:0;" >{{coment.descripcion}}</p>
						<a href="" ng-click="showForm({{coment.id}}, $event)"><small>responder</small></a>

						{% for coment1 in comentarios %}
							{% if coment1.comentario_padre.id == coment.id %}
							 
							  <div class="media clearfix">
							  	<i class="fa fa-comments-o fa-2x pull-left"></i>
							  	<div class="media-body">
							  		<h5 class="text-primary media-heading">{{coment1.commenter}}  <small>hace {{coment1.created|timesince}}</small> </h5>
							  	
							  		<p style="margin-bottom:0;" >{{coment1.descripcion}}</p>		


							  	</div>
							  </div>

							{% endif %}
						{% endfor %}


					</div>

				</li>
			{% endif %}
		</ul>
		{% endfor %}


	</br>
	</br>
	</br>



	</div>  <!-- col-sm-8   -->

	<div class="col-sm-4">

		<div class="page-header" style="margin-top:0;">
		  <h4>Autorizaciones</h4>
		</div>

		<div {% if user.tipo == user.REGIONAL %} ng-mouseenter="showAutorizacionForm($event)" ng-mouseleave="showAutorizacionForm($event)"{% endif %}
			 class="panel {% if proyecto.aprobacion_regional %} panel-green {% else %} panel-red {% endif %}">
		    <div class="panel-heading">
		        <div class="row">
		            <div class="col-xs-3">
		            	
		                <i class="fa {% if proyecto.aprobacion_regional %} fa-check {% else %} fa-lock {% endif %}  fa-2x"></i>
		            </div>
		            <div class="col-xs-9 text-right">
		                <i class="fa fa-user"></i>  REGIONAL  
		            </div>
		        </div>
		    </div>
			{% if user.tipo == user.REGIONAL %}
		    <div class="panel-body" style="text-align:center;" ng-show="verFormAutorizacion">
		    	<form action="/proyecto/{{proyecto.id}}/autorizaciones/" method="post">{% csrf_token %}
					{{ aprobacionRegionalForm.aprobacion_regional }}&nbsp;&nbsp;&nbsp;
					{% if proyecto.aprobacion_regional %} 
						<button class="btn btn-danger btn-xs"><i class="fa fa-square-o"></i> desautorizar</button>
					{% else %} 
						<button class="btn btn-success btn-xs"><i class="fa fa-check"></i> autorizar</button> 
					{% endif %}
					 
				</form>
		    </div>
		    {% endif %}
		</div>


		<div {% if user.tipo == user.ARQUITECTO %} ng-mouseenter="showAutorizacionForm($event)" ng-mouseleave="showAutorizacionForm($event)"{% endif %}
			 class="panel {% if proyecto.aprobacion_arquitecto %} panel-green {% else %} panel-red {% endif %}">
		    <div class="panel-heading">
		        <div class="row">
		            <div class="col-xs-3">
		            	
		                <i class="fa {% if proyecto.aprobacion_arquitecto %} fa-check {% else %} fa-lock {% endif %}  fa-2x"></i>
		            </div>
		            <div class="col-xs-9 text-right">
		                <i class="fa fa-user"></i>  ARQUITECTO  
		            </div>
		        </div>
		    </div>
			{% if user.tipo == user.ARQUITECTO %}
		    <div class="panel-body" style="text-align:center;" ng-show="verFormAutorizacion">
		    	<form action="/proyecto/{{proyecto.id}}/autorizaciones/" method="post">{% csrf_token %}
					{{ aprobacionRegionalForm.aprobacion_arquitecto }}&nbsp;&nbsp;&nbsp;
					{% if proyecto.aprobacion_arquitecto %} 
						<button class="btn btn-danger btn-xs"><i class="fa fa-square-o"></i> desautorizar</button>
					{% else %} 
						<button class="btn btn-success btn-xs"><i class="fa fa-check"></i> autorizar</button> 
					{% endif %}
					 
				</form>
		    </div>
		    {% endif %}
		</div>

		
		<div class="page-header" >
		  <h4>Asignaciones</h4>
		</div>


		<ul class="list-group" 
			{% if user.tipo == user.NACIONAL %} ng-mouseenter="showAsignacionForm($event)" ng-mouseleave="showAsignacionForm($event)"{% endif %}>

		    <li class="list-group-item">
		      <span class="badge">{{proyecto.arquitecto.tipo}}</span>
		      <i class="fa fa-user fa-fw"></i> {{proyecto.arquitecto|default_if_none:"arquitecto no asignado"}}
		    </li>
		    <li class="list-group-item">
		      <span class="badge">{{proyecto.ingeniero.tipo}}</span>
		      <i class="fa fa-user fa-fw"></i> {{proyecto.ingeniero|default_if_none:"ingeniero no asignado"}}
		    </li>
		    <li class="list-group-item">
		      <span class="badge">{{proyecto.tesorero.tipo}}</span>
		      <i class="fa fa-user fa-fw"></i> {{proyecto.tesorero|default_if_none:"tesorero no asignado"}}
		    </li>
		    
		    {% if user.tipo == user.NACIONAL %}
			<li class="list-group-item" ng-show="verFormAsignacion">
				<div class="well well-sm">Asignar usuarios</div>
				{% crispy asignarUsuariosForm %}				
			</li>
			{% endif %}

		</ul>


	</div> <!-- col-sm-4   -->


</div>	

{% endblock content %}


{% block js_body %} 
	<script src="{{STATIC_URL}}main/leaflet/leaflet.js"></script>
	<script src="{{STATIC_URL}}main/js/angular-leaflet-directive.min.js"></script>
	
	<script>
		window.latitud  = parseFloat( '{{proyecto.coordenadas.lat}}'.replace(",", ".") );
		window.longitud = parseFloat( '{{proyecto.coordenadas.lon}}'.replace(",", ".") );
	</script>
	
	<script src="{{STATIC_URL}}main/app/proyectoApp.js"></script>
{% endblock js_body %}